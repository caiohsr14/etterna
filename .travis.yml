language: cpp
dist: trusty
sudo: required

matrix:
  include:
  - env: CXX_COMPILER=clang++-4.0 CC_COMPILER=clang-4.0 BUILD_TYPE=Release WITH_FFMPEG=ON WITH_FFMPEG_JOBS=1
    compiler: clang
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        - llvm-toolchain-trusty-4.0
        packages:
        - nasm
        - libudev-dev
        - clang-4.0
        - clang-format-4.0
        - clang-tidy-4.0
        - libmad0-dev
        - libgtk2.0-dev
        - binutils-dev
        - libasound-dev
        - libpulse-dev
        - libjack-dev
        - libc6-dev
        - libogg-dev
        - libvorbis-dev
        - libxtst-dev
        - libxrandr-dev
        - libglew-dev
      coverity_scan:
        project:
          name: etternagame/etterna
          description: "Build submitted via Travis CI"
        notification_email: etternadev@gmail.com
        build_command_prepend: "cov-configure --comptype clang --compiler clang-4.0 --template"
        build_command: "make -j 4"
        branch_pattern: coverity_scan
  - env: CXX_COMPILER=g++-7 CC_COMPILER=gcc-7 BUILD_TYPE=Release WITH_FFMPEG=ON WITH_FFMPEG_JOBS=1
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - nasm
        - libudev-dev
        - g++-7
        - libmad0-dev
        - libgtk2.0-dev
        - binutils-dev
        - libasound-dev
        - libpulse-dev
        - libjack-dev
        - libc6-dev
        - libogg-dev
        - libvorbis-dev
        - libxtst-dev
        - libxrandr-dev
        - libglew-dev

install:
  - DEPS_DIR="${TRAVIS_BUILD_DIR}/deps"
  - mkdir -p ${DEPS_DIR} && cd ${DEPS_DIR}
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      CMAKE_URL="https://cmake.org/files/v3.9/cmake-3.9.1-Linux-x86_64.tar.gz"
      mkdir cmake && travis_retry wget --no-check-certificate --quiet -O - ${CMAKE_URL} | tar --strip-components=1 -xz -C cmake
      export PATH=${DEPS_DIR}/cmake/bin:${PATH}
    else
      brew upgrade cmake || brew install cmake
    fi
  - cmake --version

before_script:
  - sudo ln -s /usr/include/x86_64-linux-gnu/zconf.h /usr/include
  - cd ${TRAVIS_BUILD_DIR}/Build
  - cmake .. -DCMAKE_CXX_COMPILER=${CXX_COMPILER} -DCMAKE_C_COMPILER=${CC_COMPILER} -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DWITH_FFMPEG=${WITH_FFMPEG} -DWITH_FFMPEG_JOBS=${WITH_FFMPEG_JOBS}

script:
  - if [ "${COVERITY_SCAN_BRANCH}" != 1 ]; then make -j 4; fi
  - make clang-tidy
  - make clang-format

env:
  global:
    secure: gXXVXUQdzic8X/WhHgPih7zEPOMvzz1o4XudnEgiIGrk5gwVajXLVc0TEVT9uogeuHZxhT0sM7idYmtSXTe6zUBfoV/WXnyfeZVQhI59iy35bWUKdbpPpO9bAafdmMB2d9b3v5QT8iubOPAudVNGENBZiXiGovAJBmqxnjpjdU1aQBsy5rhFssSOcizIV7GrOcsCGoilTceonPtLp8xX2mt/WQJhPHrAUmZks5uPNNYDXv9a8BoLeTYKzbFoz7GNvoxEUfmFV2W2jr/szfpnbmvRMqKgErsJDlc2b/oaD0EKUJOdu8eNNuOpLKZSPiMQstmDZtQ65boOuXVudAx3T1zFaDhhP3PZwG6KLwnrf0ttLRSdIW5Mm+SzEHuJXp2qwBPyAQJIKJLqqu/OUeNorWfz0jFvYyVlNZlTX5ZaxjEj05qj3DAEfokCuueNY+KFccdouMQX0ks3of4/WKLYH1BL743Binc5SYgK38xA7bzwcjFyyEBQFoc9FayrLkk0Yi/ed2mV1XdBvr7vmFxYDlZQkg425KLtCX7GN/++5FVF01IH1cZa3siJ7XT5EJBu6vxisByHRwPSWWagn2WgvkxHjgAnBcvgYBIcoKsxFBytsyyh3g5fVSWovSnTerr5glwv7cXdyhMAXp1gGL900tjij0BiEWRzKfbiroDjVn0=
